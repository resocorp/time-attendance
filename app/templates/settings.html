<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZK Attendance Pro - Settings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .toggle-checkbox:checked { right: 0; border-color: #667eea; }
        .toggle-checkbox:checked + .toggle-label { background-color: #667eea; }
        .punch-type-badge {
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600;
        }
        .type-CHECK_IN { background: #d1fae5; color: #065f46; }
        .type-CHECK_OUT { background: #fee2e2; color: #991b1b; }
        .type-BREAK_OUT { background: #fef3c7; color: #92400e; }
        .type-BREAK_IN { background: #dbeafe; color: #1e40af; }
        .type-OVERTIME_IN { background: #ede9fe; color: #5b21b6; }
        .type-OVERTIME_OUT { background: #fce7f3; color: #9d174d; }
        /* Navigation styles */
        .nav-link { background: rgba(255,255,255,0.1); }
        .nav-link:hover { background: rgba(255,255,255,0.25); }
        .nav-link.active { background: rgba(255,255,255,0.3); font-weight: 600; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="gradient-bg text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-3">
            <div class="flex items-center justify-between">
                <!-- Logo -->
                <a href="/dashboard" class="flex items-center space-x-3 hover:opacity-90 transition">
                    <i data-lucide="fingerprint" class="w-8 h-8"></i>
                    <h1 class="text-xl font-bold">ZK Attendance Pro</h1>
                </a>
                
                <!-- Main Navigation -->
                <div class="flex items-center space-x-1">
                    <a href="/dashboard" class="nav-link flex items-center space-x-2 px-4 py-2 rounded-lg transition">
                        <i data-lucide="layout-dashboard" class="w-4 h-4"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="/employees" class="nav-link flex items-center space-x-2 px-4 py-2 rounded-lg transition">
                        <i data-lucide="users" class="w-4 h-4"></i>
                        <span>Employees</span>
                    </a>
                    <a href="/reports" class="nav-link flex items-center space-x-2 px-4 py-2 rounded-lg transition">
                        <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                        <span>Reports</span>
                    </a>
                    <a href="/monitor" class="nav-link flex items-center space-x-2 px-4 py-2 rounded-lg transition">
                        <i data-lucide="activity" class="w-4 h-4"></i>
                        <span>Live Monitor</span>
                    </a>
                    <a href="/settings" class="nav-link active flex items-center space-x-2 px-4 py-2 rounded-lg transition">
                        <i data-lucide="settings" class="w-4 h-4"></i>
                        <span>Settings</span>
                    </a>
                </div>
                
                <!-- Spacer for alignment -->
                <div class="w-24"></div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <div class="flex items-center justify-between mb-8">
            <div class="flex items-center space-x-4">
                <h2 class="text-2xl font-semibold text-gray-800">Settings</h2>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Time Windows -->
            <div class="lg:col-span-2">
                <!-- Auto Punch Type Toggle -->
                <div class="card p-6 mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Automatic Punch Type</h3>
                            <p class="text-gray-500 text-sm mt-1">
                                When enabled, punch type is determined by time windows instead of device status.
                                This eliminates user errors from incorrect manual status selection.
                            </p>
                        </div>
                        <div class="relative inline-block w-12 align-middle select-none">
                            <input type="checkbox" id="auto-punch-toggle" 
                                   class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-200"
                                   style="right: 24px;"
                                   onchange="toggleAutoPunch(this.checked)">
                            <label for="auto-punch-toggle" 
                                   class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer transition-colors duration-200"></label>
                        </div>
                    </div>
                </div>

                <!-- Time Windows -->
                <div class="card p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800">Time Windows</h3>
                            <p class="text-gray-500 text-sm">Configure when each punch type is active</p>
                        </div>
                        <button onclick="showAddWindow()" class="flex items-center space-x-2 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            <span>Add Window</span>
                        </button>
                    </div>

                    <!-- Time Windows Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200">
                                    <th class="text-left py-3 px-4 text-gray-600 font-medium">Punch Type</th>
                                    <th class="text-left py-3 px-4 text-gray-600 font-medium">Time</th>
                                    <th class="text-left py-3 px-4 text-gray-600 font-medium">Days</th>
                                    <th class="text-left py-3 px-4 text-gray-600 font-medium">Status</th>
                                    <th class="text-left py-3 px-4 text-gray-600 font-medium">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="time-windows-table">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Visual Timeline -->
                <div class="card p-6 mt-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">24-Hour Timeline</h3>
                    <div class="relative h-16 bg-gray-100 rounded-lg overflow-hidden" id="timeline-visual">
                        <!-- Populated by JavaScript -->
                    </div>
                    <div class="flex justify-between text-xs text-gray-500 mt-2">
                        <span>00:00</span>
                        <span>06:00</span>
                        <span>12:00</span>
                        <span>18:00</span>
                        <span>24:00</span>
                    </div>
                </div>
            </div>

            <!-- Right Column: Test & Other Settings -->
            <div class="space-y-6">
                <!-- Test Punch Type -->
                <div class="card p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Test Punch Type</h3>
                    <p class="text-gray-500 text-sm mb-4">Enter a date and time to see what punch type would be assigned</p>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Date</label>
                            <input type="date" id="test-date" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Time</label>
                            <input type="time" id="test-time" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <button onclick="testPunchType()" class="w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">
                            Test
                        </button>
                    </div>
                    <div id="test-result" class="mt-4 hidden">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-sm text-gray-600">
                                Result for <span id="test-day-name" class="font-semibold"></span>, 
                                <span id="test-time-display" class="font-mono font-semibold"></span>:
                            </p>
                            <p class="text-lg font-semibold mt-1">
                                <span id="test-punch-type" class="punch-type-badge"></span>
                            </p>
                            <p class="text-xs text-gray-500 mt-2">Source: <span id="test-source"></span></p>
                        </div>
                    </div>
                </div>

                <!-- Work Hours Settings -->
                <div class="card p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Work Hours</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Work Start Time</label>
                            <input type="time" id="work-start-time" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Work End Time</label>
                            <input type="time" id="work-end-time" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Overtime Threshold (hours)</label>
                            <input type="number" id="overtime-threshold" min="1" max="24" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <button onclick="saveWorkHours()" class="w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">
                            Save Work Hours
                        </button>
                    </div>
                </div>

                <!-- Info Card -->
                <div class="card p-6 bg-blue-50 border border-blue-200">
                    <div class="flex items-start space-x-3">
                        <i data-lucide="info" class="w-5 h-5 text-blue-600 mt-0.5"></i>
                        <div>
                            <h4 class="font-semibold text-blue-800">How It Works</h4>
                            <p class="text-sm text-blue-700 mt-1">
                                When automatic punch type is enabled, the system ignores the device's status button 
                                and assigns punch types based on the time of the punch. This prevents errors when 
                                employees forget to press the correct status button.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Add/Edit Window Modal -->
    <div id="window-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <h3 id="modal-title" class="text-lg font-semibold text-gray-800 mb-4">Add Time Window</h3>
            <form id="window-form" onsubmit="saveWindow(event)">
                <input type="hidden" id="window-id">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Punch Type</label>
                        <select id="window-punch-type" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            <option value="CHECK_IN">Check In</option>
                            <option value="CHECK_OUT">Check Out</option>
                            <option value="BREAK_OUT">Break Out</option>
                            <option value="BREAK_IN">Break In</option>
                            <option value="OVERTIME_IN">Overtime In</option>
                            <option value="OVERTIME_OUT">Overtime Out</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Start Time</label>
                            <input type="time" id="window-start-time" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">End Time</label>
                            <input type="time" id="window-end-time" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-2">Days of Week</label>
                        <div class="flex flex-wrap gap-2">
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="day-0" value="0" checked class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                                <span class="ml-1 text-sm">Mon</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="day-1" value="1" checked class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                                <span class="ml-1 text-sm">Tue</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="day-2" value="2" checked class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                                <span class="ml-1 text-sm">Wed</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="day-3" value="3" checked class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                                <span class="ml-1 text-sm">Thu</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="day-4" value="4" checked class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                                <span class="ml-1 text-sm">Fri</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="day-5" value="5" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                                <span class="ml-1 text-sm">Sat</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="day-6" value="6" class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                                <span class="ml-1 text-sm">Sun</span>
                            </label>
                        </div>
                        <div class="flex gap-2 mt-2">
                            <button type="button" onclick="selectAllDays()" class="text-xs text-purple-600 hover:underline">All</button>
                            <button type="button" onclick="selectWeekdays()" class="text-xs text-purple-600 hover:underline">Weekdays</button>
                            <button type="button" onclick="selectWeekends()" class="text-xs text-purple-600 hover:underline">Weekends</button>
                            <button type="button" onclick="clearDays()" class="text-xs text-gray-500 hover:underline">Clear</button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Priority (lower = higher priority)</label>
                        <input type="number" id="window-priority" value="0" min="0" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">Description (optional)</label>
                        <input type="text" id="window-description" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="window-active" checked class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500">
                        <label for="window-active" class="text-sm text-gray-600">Active</label>
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition">
                        Cancel
                    </button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Color map for timeline
        const typeColors = {
            'CHECK_IN': '#10b981',
            'CHECK_OUT': '#ef4444',
            'BREAK_OUT': '#f59e0b',
            'BREAK_IN': '#3b82f6',
            'OVERTIME_IN': '#8b5cf6',
            'OVERTIME_OUT': '#ec4899'
        };

        const typeLabels = {
            'CHECK_IN': 'Check In',
            'CHECK_OUT': 'Check Out',
            'BREAK_OUT': 'Break Out',
            'BREAK_IN': 'Break In',
            'OVERTIME_IN': 'Overtime In',
            'OVERTIME_OUT': 'Overtime Out'
        };

        const dayLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const dayLabelsFull = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

        function formatDays(daysStr) {
            if (!daysStr) return 'All days';
            const days = daysStr.split(',').map(d => parseInt(d.trim())).sort();
            
            // Check for common patterns
            if (days.length === 7) return 'All days';
            if (days.length === 5 && days.join(',') === '0,1,2,3,4') return 'Mon-Fri';
            if (days.length === 2 && days.join(',') === '5,6') return 'Sat-Sun';
            
            // Otherwise show abbreviated days
            return days.map(d => dayLabels[d]).join(', ');
        }

        // Load data on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadTimeWindows();
            loadSettings();
        });

        async function loadTimeWindows() {
            try {
                const response = await fetch('/api/time-windows');
                const data = await response.json();
                
                // Update toggle
                document.getElementById('auto-punch-toggle').checked = data.auto_enabled;
                updateTogglePosition(data.auto_enabled);
                
                // Render table
                renderTimeWindowsTable(data.windows);
                
                // Render timeline
                renderTimeline(data.windows);
            } catch (error) {
                console.error('Error loading time windows:', error);
            }
        }

        async function loadSettings() {
            try {
                const response = await fetch('/api/settings');
                const settings = await response.json();
                
                if (settings.work_start_time) {
                    document.getElementById('work-start-time').value = settings.work_start_time.value;
                }
                if (settings.work_end_time) {
                    document.getElementById('work-end-time').value = settings.work_end_time.value;
                }
                if (settings.overtime_threshold_hours) {
                    document.getElementById('overtime-threshold').value = settings.overtime_threshold_hours.value;
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        function updateTogglePosition(checked) {
            const toggle = document.getElementById('auto-punch-toggle');
            toggle.style.right = checked ? '0px' : '24px';
        }

        function renderTimeWindowsTable(windows) {
            const tbody = document.getElementById('time-windows-table');
            tbody.innerHTML = windows.map(w => `
                <tr class="border-b border-gray-100 hover:bg-gray-50">
                    <td class="py-3 px-4">
                        <span class="punch-type-badge type-${w.punch_type}">${typeLabels[w.punch_type] || w.punch_type}</span>
                    </td>
                    <td class="py-3 px-4">
                        <span class="font-mono">${w.start_time} - ${w.end_time}</span>
                    </td>
                    <td class="py-3 px-4">
                        <span class="text-sm text-gray-600">${formatDays(w.days_of_week)}</span>
                    </td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 rounded-full text-xs ${w.is_active ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}">
                            ${w.is_active ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td class="py-3 px-4">
                        <div class="flex items-center space-x-2">
                            <button onclick="editWindow(${w.id})" class="p-1 text-gray-500 hover:text-purple-600 transition">
                                <i data-lucide="edit-2" class="w-4 h-4"></i>
                            </button>
                            <button onclick="deleteWindow(${w.id})" class="p-1 text-gray-500 hover:text-red-600 transition">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            lucide.createIcons();
        }

        function renderTimeline(windows) {
            const timeline = document.getElementById('timeline-visual');
            timeline.innerHTML = '';
            
            windows.filter(w => w.is_active).forEach(w => {
                const startMins = timeToMinutes(w.start_time);
                const endMins = timeToMinutes(w.end_time);
                const totalMins = 24 * 60;
                
                const left = (startMins / totalMins) * 100;
                let width;
                
                if (endMins > startMins) {
                    width = ((endMins - startMins) / totalMins) * 100;
                } else {
                    // Overnight window - just show first part for simplicity
                    width = ((totalMins - startMins) / totalMins) * 100;
                }
                
                const div = document.createElement('div');
                div.className = 'absolute h-full flex items-center justify-center text-white text-xs font-medium';
                div.style.left = `${left}%`;
                div.style.width = `${width}%`;
                div.style.backgroundColor = typeColors[w.punch_type] || '#6b7280';
                div.title = `${typeLabels[w.punch_type]}: ${w.start_time} - ${w.end_time}`;
                div.textContent = width > 8 ? typeLabels[w.punch_type] : '';
                
                timeline.appendChild(div);
            });
        }

        function timeToMinutes(time) {
            const [hours, mins] = time.split(':').map(Number);
            return hours * 60 + mins;
        }

        async function toggleAutoPunch(enabled) {
            try {
                await fetch('/api/settings/auto_punch_type_enabled', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ value: enabled ? 'true' : 'false' })
                });
                updateTogglePosition(enabled);
            } catch (error) {
                console.error('Error updating setting:', error);
            }
        }

        function showAddWindow() {
            document.getElementById('modal-title').textContent = 'Add Time Window';
            document.getElementById('window-id').value = '';
            document.getElementById('window-form').reset();
            document.getElementById('window-active').checked = true;
            // Default to weekdays
            selectWeekdays();
            document.getElementById('window-modal').classList.remove('hidden');
            document.getElementById('window-modal').classList.add('flex');
        }

        async function editWindow(id) {
            try {
                const response = await fetch('/api/time-windows');
                const data = await response.json();
                const window = data.windows.find(w => w.id === id);
                
                if (window) {
                    document.getElementById('modal-title').textContent = 'Edit Time Window';
                    document.getElementById('window-id').value = window.id;
                    document.getElementById('window-punch-type').value = window.punch_type;
                    document.getElementById('window-start-time').value = window.start_time;
                    document.getElementById('window-end-time').value = window.end_time;
                    document.getElementById('window-priority').value = window.priority;
                    document.getElementById('window-description').value = window.description || '';
                    document.getElementById('window-active').checked = window.is_active;
                    
                    // Set days of week checkboxes
                    clearDays();
                    if (window.days_of_week) {
                        window.days_of_week.split(',').forEach(d => {
                            const checkbox = document.getElementById(`day-${d.trim()}`);
                            if (checkbox) checkbox.checked = true;
                        });
                    } else {
                        selectAllDays();
                    }
                    
                    document.getElementById('window-modal').classList.remove('hidden');
                    document.getElementById('window-modal').classList.add('flex');
                }
            } catch (error) {
                console.error('Error loading window:', error);
            }
        }

        function closeModal() {
            document.getElementById('window-modal').classList.add('hidden');
            document.getElementById('window-modal').classList.remove('flex');
        }

        function getSelectedDays() {
            const days = [];
            for (let i = 0; i < 7; i++) {
                if (document.getElementById(`day-${i}`).checked) {
                    days.push(i);
                }
            }
            return days.join(',');
        }

        function selectAllDays() {
            for (let i = 0; i < 7; i++) {
                document.getElementById(`day-${i}`).checked = true;
            }
        }

        function selectWeekdays() {
            for (let i = 0; i < 7; i++) {
                document.getElementById(`day-${i}`).checked = i < 5;
            }
        }

        function selectWeekends() {
            for (let i = 0; i < 7; i++) {
                document.getElementById(`day-${i}`).checked = i >= 5;
            }
        }

        function clearDays() {
            for (let i = 0; i < 7; i++) {
                document.getElementById(`day-${i}`).checked = false;
            }
        }

        async function saveWindow(event) {
            event.preventDefault();
            
            const id = document.getElementById('window-id').value;
            const selectedDays = getSelectedDays();
            
            if (!selectedDays) {
                alert('Please select at least one day of the week');
                return;
            }
            
            const data = {
                punch_type: document.getElementById('window-punch-type').value,
                start_time: document.getElementById('window-start-time').value,
                end_time: document.getElementById('window-end-time').value,
                days_of_week: selectedDays,
                priority: parseInt(document.getElementById('window-priority').value),
                description: document.getElementById('window-description').value,
                is_active: document.getElementById('window-active').checked
            };
            
            try {
                const url = id ? `/api/time-windows/${id}` : '/api/time-windows';
                const method = id ? 'PUT' : 'POST';
                
                await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                closeModal();
                loadTimeWindows();
            } catch (error) {
                console.error('Error saving window:', error);
            }
        }

        async function deleteWindow(id) {
            if (!confirm('Are you sure you want to delete this time window?')) return;
            
            try {
                await fetch(`/api/time-windows/${id}`, { method: 'DELETE' });
                loadTimeWindows();
            } catch (error) {
                console.error('Error deleting window:', error);
            }
        }

        async function testPunchType() {
            const time = document.getElementById('test-time').value;
            const date = document.getElementById('test-date').value;
            
            if (!time) {
                alert('Please enter a time to test');
                return;
            }
            
            try {
                let url = `/api/test-punch-type?time=${time}`;
                if (date) {
                    url += `&date=${date}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                document.getElementById('test-result').classList.remove('hidden');
                document.getElementById('test-time-display').textContent = time;
                document.getElementById('test-day-name').textContent = data.day_name;
                
                const punchTypeEl = document.getElementById('test-punch-type');
                const punchType = data.determined_punch_type || 'NO_MATCH';
                punchTypeEl.textContent = typeLabels[punchType] || punchType;
                punchTypeEl.className = `punch-type-badge type-${punchType}`;
                
                document.getElementById('test-source').textContent = data.would_use;
            } catch (error) {
                console.error('Error testing punch type:', error);
            }
        }

        async function saveWorkHours() {
            try {
                const workStart = document.getElementById('work-start-time').value;
                const workEnd = document.getElementById('work-end-time').value;
                const overtimeThreshold = document.getElementById('overtime-threshold').value;
                
                await Promise.all([
                    fetch('/api/settings/work_start_time', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ value: workStart })
                    }),
                    fetch('/api/settings/work_end_time', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ value: workEnd })
                    }),
                    fetch('/api/settings/overtime_threshold_hours', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ value: overtimeThreshold })
                    })
                ]);
                
                alert('Work hours saved successfully!');
            } catch (error) {
                console.error('Error saving work hours:', error);
                alert('Error saving work hours');
            }
        }
    </script>
</body>
</html>
